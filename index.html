<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
  />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="–ó–∞—è–≤–∫–∏" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --indigo:#4f46e5;
      --purple:#7c3aed;
      --green1:#10b981;
      --green2:#059669;
      --amber1:#f59e0b;
      --amber2:#d97706;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    iframe{width:100%;height:100%;border:none}

    .hidden{display:none!important}

    .loader{
      position:fixed;inset:0;
      background:linear-gradient(135deg,var(--indigo),var(--purple));
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      text-align:center;
    }
    .loader-icon{
      width:80px;height:80px;background:#fff;border-radius:20px;
      display:flex;align-items:center;justify-content:center;
      margin-bottom:24px;animation:pulse 2s infinite;
    }
    .loader-icon svg{width:40px;height:40px;fill:var(--indigo)}
    .loader-text{font-size:24px;font-weight:700;margin-bottom:8px}
    .loader-sub{font-size:14px;opacity:.85}

    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    .notify-btn{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:#fff;color:var(--indigo);border:none;
      padding:14px 28px;border-radius:12px;
      font-size:16px;font-weight:600;cursor:pointer;
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      z-index:1000;display:none;
    }
    .notify-btn:hover{background:#f0f0f0}

    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.5);
      z-index:1001;display:none;
    }

    .email-prompt{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#fff;padding:24px;border-radius:16px;
      box-shadow:0 4px 30px rgba(0,0,0,.3);
      z-index:1002;display:none;text-align:center;
      width:min(92vw,360px);
    }
    .email-prompt input{
      padding:12px;border:2px solid #ddd;border-radius:8px;
      font-size:16px;width:100%;margin:12px 0;
      outline:none;
    }
    .email-prompt input:focus{border-color:var(--indigo)}
    .email-prompt button{
      padding:12px 24px;background:var(--indigo);color:#fff;
      border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px;
    }

    .change-email-btn{
      position:fixed;top:8px;right:8px;
      background:rgba(0,0,0,.32);color:#fff;border:none;
      padding:6px 10px;border-radius:6px;font-size:10px;
      cursor:pointer;z-index:1000;display:none;opacity:.75;
      backdrop-filter: blur(6px);
    }
    .change-email-btn:hover{opacity:1;background:rgba(0,0,0,.5)}

    .bottom-btns{
      position:fixed;bottom:12px;left:12px;
      display:flex;flex-direction:column;gap:8px;z-index:1000;
    }

    .apk-btn,.thanks-btn{
      border:none;padding:10px 16px;border-radius:10px;
      font-size:12px;font-weight:700;cursor:pointer;
      display:flex;align-items:center;gap:6px;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      transform:translateZ(0);
      transition:transform .15s ease, opacity .35s ease;
      text-decoration:none;
      user-select:none;
    }
    .apk-btn{background:linear-gradient(135deg,var(--green1),var(--green2));color:#fff}
    .thanks-btn{background:linear-gradient(135deg,var(--amber1),var(--amber2));color:#fff}
    .apk-btn:hover,.thanks-btn:hover{transform:scale(1.03)}

    /* –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ */
    .fade-out{
      opacity:0;
      pointer-events:none;
      transform:scale(.98);
    }

    .thanks-modal{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#fff;padding:28px;border-radius:20px;
      box-shadow:0 4px 30px rgba(0,0,0,.4);
      z-index:1003;display:none;text-align:center;
      max-width:320px;width:90%;
    }
    .thanks-modal h3{font-size:20px;margin-bottom:12px;color:#333}
    .thanks-modal p{font-size:14px;color:#666;margin-bottom:16px;line-height:1.5}
    .thanks-modal .timer{font-size:32px;font-weight:800;color:var(--amber1);margin-bottom:16px}
    .thanks-modal .links{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .thanks-modal .links a{
      padding:12px 20px;border-radius:10px;text-decoration:none;
      font-weight:800;font-size:14px;display:flex;align-items:center;gap:6px;
    }
    .thanks-modal .wa-link{background:#25d366;color:#fff}
    .thanks-modal .tg-link{background:#0088cc;color:#fff}
  </style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="loader-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24">
        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
      </svg>
    </div>
    <div class="loader-text">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</div>
    <div class="loader-sub">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="overlay" id="overlay" onclick="closeEmailPrompt()"></div>
  <div class="overlay" id="thanksOverlay" onclick="closeThanksModal()" style="display:none"></div>

  <div class="email-prompt" id="emailPrompt" role="dialog" aria-modal="true" aria-label="Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
    <div style="font-weight:800;font-size:18px;margin-bottom:4px">üìß Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
    <div style="font-size:12px;color:#666;margin-bottom:8px">–£–∫–∞–∂–∏—Ç–µ email –∏–∑ —Å–∏—Å—Ç–µ–º—ã</div>
    <input type="email" id="promptEmail" placeholder="email@example.com" autocomplete="email" />
    <br />
    <button onclick="submitEmail()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div class="thanks-modal" id="thanksModal" role="dialog" aria-modal="true" aria-label="–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞">
    <h3>üç∫ –°–ø–∞—Å–∏–±–æ!</h3>
    <p>–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∫–∞–∑–∞–ª–æ—Å—å –ø–æ–ª–µ–∑–Ω—ã–º, –º–æ–∂–µ—Ç–µ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚Äî —Å–∫–∏–Ω—É—Ç—å –Ω–∞ –ø–∏–≤–∫–æ –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏!</p>
    <div class="timer" id="thanksTimer">10</div>
    <div class="links">
      <a
        class="wa-link"
        href="https://wa.me/79161244687?text=–ü—Ä–∏–≤–µ—Ç!%20–•–æ—á—É%20–ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å%20–∑–∞%20–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫%20–∑–∞—è–≤–æ–∫!%20%F0%9F%8D%BA"
        target="_blank"
        rel="noopener noreferrer"
      >üí¨ WhatsApp</a>

      <a
        class="tg-link"
        href="https://t.me/TYTBoGi"
        target="_blank"
        rel="noopener noreferrer"
      >‚úàÔ∏è Telegram</a>
    </div>
  </div>

  <button class="notify-btn" id="notifyBtn" onclick="requestPermission()">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
  <button class="change-email-btn" id="changeEmailBtn" onclick="changeEmail()">‚úèÔ∏è Email</button>

  <div class="bottom-btns" id="bottomBtns">
    <a
      class="apk-btn"
      id="apkBtn"
      href="https://github.com/Weltkind666/planzayavok-pwa/releases/download/Planner/default.apk"
      target="_blank"
      rel="noopener noreferrer"
    >üì≤ –°–∫–∞—á–∞—Ç—å –Ω–∞ Android</a>

    <button class="thanks-btn" id="thanksBtn" onclick="openThanksModal()">‚òï –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</button>
  </div>

  <iframe
    id="app"
    class="hidden"
    src="https://script.google.com/macros/s/AKfycbziJi6zBrH0meVhi27JPdFquQYGhjDK2iX0EIjKrRplhW8E9CQZAkA1ZQpdiNqVsGI1/exec"
  ></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD2HkY76nLBhE7GuCwXi1j6qzKyYPSmypg",
      authDomain: "planzayavok.firebaseapp.com",
      projectId: "planzayavok",
      storageBucket: "planzayavok.firebasestorage.app",
      messagingSenderId: "655180080768",
      appId: "1:655180080768:web:449d8189bf747d34b46865"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // SW (–æ—Å–Ω–æ–≤–Ω–æ–π)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("sw.js")
        .then(() => console.log("SW registered"))
        .catch((e) => console.log("SW error", e));
    }

    const iframe = document.getElementById("app");
    const loader = document.getElementById("loader");
    const notifyBtn = document.getElementById("notifyBtn");
    const emailPrompt = document.getElementById("emailPrompt");
    const overlay = document.getElementById("overlay");
    const changeEmailBtn = document.getElementById("changeEmailBtn");

    const thanksModal = document.getElementById("thanksModal");
    const thanksOverlay = document.getElementById("thanksOverlay");
    const thanksTimer = document.getElementById("thanksTimer");

    const apkBtn = document.getElementById("apkBtn");
    const thanksBtn = document.getElementById("thanksBtn");

    let timerInterval = null;

    // ‚úÖ –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ (–ø–ª–∞–≤–Ω–æ)
    function autoHideBottomButtons() {
      const HIDE_AFTER_MS = 10000;

      setTimeout(() => {
        [apkBtn, thanksBtn].forEach((el) => {
          if (!el) return;
          el.classList.add("fade-out");
          // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —É–±–∏—Ä–∞–µ–º –∏–∑ –ø–æ—Ç–æ–∫–∞
          setTimeout(() => {
            el.style.display = "none";
          }, 380);
        });
      }, HIDE_AFTER_MS);
    }

    iframe.onload = function () {
      setTimeout(function () {
        loader.classList.add("hidden");
        iframe.classList.remove("hidden");
        checkNotificationPermission();
        autoHideBottomButtons(); // –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      }, 500);
    };

    function openThanksModal() {
      thanksModal.style.display = "block";
      thanksOverlay.style.display = "block";

      let seconds = 10;
      thanksTimer.textContent = seconds;

      timerInterval = setInterval(function () {
        seconds--;
        thanksTimer.textContent = seconds;

        if (seconds <= 0) {
          clearInterval(timerInterval);
          closeThanksModal();
          window.open(
            "https://wa.me/79161244687?text=–ü—Ä–∏–≤–µ—Ç!%20–•–æ—á—É%20–ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å%20–∑–∞%20–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫%20–∑–∞—è–≤–æ–∫!%20%F0%9F%8D%BA",
            "_blank",
            "noopener,noreferrer"
          );
        }
      }, 1000);
    }

    function closeThanksModal() {
      thanksModal.style.display = "none";
      thanksOverlay.style.display = "none";
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function checkNotificationPermission() {
      if (!("Notification" in window)) return;

      const savedEmail = localStorage.getItem("pushEmail") || "";

      if (Notification.permission === "default") {
        notifyBtn.style.display = "block";
        notifyBtn.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
        notifyBtn.style.background = "#fff";
        notifyBtn.style.color = "#4f46e5";
        changeEmailBtn.style.display = "none";
      } else if (Notification.permission === "denied") {
        notifyBtn.style.display = "none";
        changeEmailBtn.style.display = "none";
      } else {
        notifyBtn.style.display = "none";
        if (savedEmail) {
          changeEmailBtn.style.display = "block";
        } else {
          notifyBtn.style.display = "block";
          notifyBtn.textContent = "üîî –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
          notifyBtn.style.background = "#fff";
          notifyBtn.style.color = "#4f46e5";
          changeEmailBtn.style.display = "none";
        }
      }
    }

    function closeEmailPrompt() {
      emailPrompt.style.display = "none";
      overlay.style.display = "none";
    }

    function changeEmail() {
      const currentEmail = localStorage.getItem("pushEmail") || "";
      document.getElementById("promptEmail").value = currentEmail;
      emailPrompt.style.display = "block";
      overlay.style.display = "block";
      document.getElementById("promptEmail").focus();
    }

    function isValidEmail(email) {
      // –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
    }

    async function requestPermission() {
      try {
        const permission = await Notification.requestPermission();
        console.log("Permission:", permission);

        if (permission === "granted") {
          notifyBtn.textContent = "‚úÖ –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω...";
          notifyBtn.style.background = "#10b981";
          notifyBtn.style.color = "#fff";
          await getTokenAndSave();
        } else {
          notifyBtn.textContent = "üîï –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ";
          notifyBtn.style.background = "#ef4444";
          notifyBtn.style.color = "#fff";
          setTimeout(function () {
            notifyBtn.style.display = "none";
          }, 3000);
        }
      } catch (err) {
        console.error("Permission error:", err);
        notifyBtn.textContent = "‚ùå –û—à–∏–±–∫–∞";
        notifyBtn.style.background = "#ef4444";
      }
    }

    async function getTokenAndSave() {
      try {
        // –æ—Ç–¥–µ–ª—å–Ω—ã–π SW –¥–ª—è firebase messaging
        const swReg = await navigator.serviceWorker.register("firebase-messaging-sw.js");

        const token = await messaging.getToken({
          vapidKey: "BJ5PR5eT1hyx47uNgz8EAqThCVqGKGrJmOZ-q14Gjl5StjpOkilCj3tYRD8dIzVJJPg1tGql5WVPTfJM2OnVvcg",
          serviceWorkerRegistration: swReg
        });

        console.log("FCM Token:", token);
        localStorage.setItem("fcmToken", token);

        const email = localStorage.getItem("pushEmail") || "";
        if (!email) {
          notifyBtn.style.display = "none";
          emailPrompt.style.display = "block";
          overlay.style.display = "block";
          document.getElementById("promptEmail").focus();
          return;
        }

        saveTokenToServer(token, email);
        notifyBtn.style.display = "none";
        changeEmailBtn.style.display = "block";

        new Notification("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!", {
          body: "Email: " + email,
          icon: "icon-192.png"
        });
      } catch (err) {
        console.error("Token error:", err);
        notifyBtn.style.display = "none";
      }
    }

    function submitEmail() {
      const email = document.getElementById("promptEmail").value.trim();

      if (!email) {
        alert("–í–≤–µ–¥–∏—Ç–µ email");
        return;
      }
      if (!isValidEmail(email)) {
        alert("–ü–æ—Ö–æ–∂–µ, email –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π");
        return;
      }

      localStorage.setItem("pushEmail", email);
      closeEmailPrompt();

      const token = localStorage.getItem("fcmToken");
      if (token) {
        saveTokenToServer(token, email);
        notifyBtn.style.display = "none";
        changeEmailBtn.style.display = "block";

        new Notification("–ì–æ—Ç–æ–≤–æ!", {
          body: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: " + email,
          icon: "icon-192.png"
        });
      } else {
        getTokenAndSave();
      }
    }

    function saveTokenToServer(token, email) {
      console.log("Saving token for:", email);

      const saveUrl =
        "https://script.google.com/macros/s/AKfycbziJi6zBrH0meVhi27JPdFquQYGhjDK2iX0EIjKrRplhW8E9CQZAkA1ZQpdiNqVsGI1/exec" +
        "?action=savePushToken" +
        "&token=" + encodeURIComponent(token) +
        "&email=" + encodeURIComponent(email);

      fetch(saveUrl, { mode: "no-cors" })
        .then(() => console.log("Token saved!"))
        .catch((e) => console.log("Save error:", e));
    }

    messaging.onMessage(function (payload) {
      console.log("Message received:", payload);
      new Notification(payload.notification.title, {
        body: payload.notification.body,
        icon: "icon-192.png"
      });
    });
  </script>
</body>
</html>
