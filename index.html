<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–ó–∞—è–≤–∫–∏">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    iframe{width:100%;height:100%;border:none}
    .loader{position:fixed;inset:0;background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-family:system-ui,sans-serif}
    .loader-icon{width:80px;height:80px;background:#fff;border-radius:20px;display:flex;align-items:center;justify-content:center;margin-bottom:24px;animation:pulse 2s infinite}
    .loader-icon svg{width:40px;height:40px;fill:#4f46e5}
    .loader-text{font-size:24px;font-weight:700;margin-bottom:8px}
    .loader-sub{font-size:14px;opacity:0.8}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .hidden{display:none!important}
    .notify-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;color:#4f46e5;border:none;padding:14px 28px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;display:none}
    .notify-btn:hover{background:#f0f0f0}
  </style>
</head>
<body>
  <div class="loader" id="loader">
    <div class="loader-icon">
      <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
    </div>
    <div class="loader-text">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</div>
    <div class="loader-sub">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
  
  <button class="notify-btn" id="notifyBtn" onclick="requestPermission()">
    üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  </button>
  
  <iframe id="app" class="hidden" src="https://script.google.com/macros/s/AKfycbziJi6zBrH0meVhi27JPdFquQYGhjDK2iX0EIjKrRplhW8E9CQZAkA1ZQpdiNqVsGI1/exec"></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD2HkY76nLBhE7GuCwXi1j6qzKyYPSmypg",
      authDomain: "planzayavok.firebaseapp.com",
      projectId: "planzayavok",
      storageBucket: "planzayavok.firebasestorage.app",
      messagingSenderId: "655180080768",
      appId: "1:655180080768:web:449d8189bf747d34b46865"
    };
    
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();
    
    // Service Worker
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').then(function(reg){
        console.log('SW registered');
      }).catch(function(e){
        console.log('SW error',e);
      });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ iframe
    const iframe = document.getElementById('app');
    const loader = document.getElementById('loader');
    const notifyBtn = document.getElementById('notifyBtn');
    
    iframe.onload = function() {
      setTimeout(function() {
        loader.classList.add('hidden');
        iframe.classList.remove('hidden');
        checkNotificationPermission();
      }, 500);
    };
    
    function checkNotificationPermission() {
      if('Notification' in window) {
        if(Notification.permission === 'default') {
          notifyBtn.style.display = 'block';
          notifyBtn.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
        } else if(Notification.permission === 'denied') {
          notifyBtn.style.display = 'block';
          notifyBtn.textContent = 'üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
          notifyBtn.style.background = '#ef4444';
          notifyBtn.style.color = '#fff';
        } else {
          notifyBtn.style.display = 'block';
          notifyBtn.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã';
          notifyBtn.style.background = '#10b981';
          notifyBtn.style.color = '#fff';
          getTokenAndSave();
          setTimeout(function(){ notifyBtn.style.display = 'none'; }, 3000);
        }
      }
    }
    
    async function requestPermission() {
      try {
        const permission = await Notification.requestPermission();
        console.log('Permission:', permission);
        if(permission === 'granted') {
          notifyBtn.textContent = '‚úÖ –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω...';
          notifyBtn.style.background = '#10b981';
          notifyBtn.style.color = '#fff';
          await getTokenAndSave();
          notifyBtn.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã';
          setTimeout(function(){ notifyBtn.style.display = 'none'; }, 3000);
        } else {
          notifyBtn.textContent = 'üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
          notifyBtn.style.background = '#ef4444';
          notifyBtn.style.color = '#fff';
        }
      } catch(err) {
        console.error('Permission error:', err);
        notifyBtn.textContent = '‚ùå –û—à–∏–±–∫–∞';
        notifyBtn.style.background = '#ef4444';
      }
    }
    
    async function getTokenAndSave() {
      try {
const swReg = await navigator.serviceWorker.register('firebase-messaging-sw.js');
const token = await messaging.getToken({
  vapidKey: 'BJ5PR5eT1hyx47uNgz8EAqThCVqGKGrJmOZ-q14Gjl5StjpOkilCj3tYRD8dIzVJJPg1tGql5WVPTfJM2OnVvcg',
  serviceWorkerRegistration: swReg
});
        console.log('FCM Token:', token);
        localStorage.setItem('fcmToken', token);
        
        var savedEmail = localStorage.getItem('savedEmail') || '';
        console.log('Saving token for email:', savedEmail);
        
        if(savedEmail && token) {
          var saveUrl = 'https://script.google.com/macros/s/AKfycbziJi6zBrH0meVhi27JPdFquQYGhjDK2iX0EIjKrRplhW8E9CQZAkA1ZQpdiNqVsGI1/exec?action=savePushToken&token='+encodeURIComponent(token)+'&email='+encodeURIComponent(savedEmail);
          console.log('Saving to:', saveUrl);
          fetch(saveUrl, {mode:'no-cors'}).then(function(){
            console.log('Token save request sent!');
          }).catch(function(e){
            console.log('Save error:', e);
          });
        } else {
          console.log('No email found, token not saved to server');
        }
        
        // –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        new Notification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!', {
          body: '–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö',
          icon: 'icon-192.png'
        });
        
      } catch(err) {
        console.error('Token error:', err);
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    messaging.onMessage(function(payload) {
      console.log('Message received:', payload);
      new Notification(payload.notification.title, {
        body: payload.notification.body,
        icon: 'icon-192.png'
      });
    });
  </script>
</body>
</html>
