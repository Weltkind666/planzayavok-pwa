<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="–ó–∞—è–≤–∫–∏" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; background: #0b1020; }
    iframe { width: 100%; height: 100%; border: none; }
    .hidden { display: none !important; }

    /* ---------- Loader ---------- */
    .loader {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow: hidden;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,0.9), transparent 60%),
                  radial-gradient(1200px 800px at 80% 80%, rgba(79,70,229,0.9), transparent 60%),
                  linear-gradient(135deg, #0b1020, #141a33);
    }
    .loader::before, .loader::after{
      content:"";
      position:absolute;
      width: 420px;
      height: 420px;
      border-radius: 999px;
      filter: blur(40px);
      opacity: 0.5;
      animation: floaty 6s ease-in-out infinite;
    }
    .loader::before{ background: rgba(16,185,129,0.65); left: -160px; top: -160px; }
    .loader::after{ background: rgba(245,158,11,0.65); right: -160px; bottom: -160px; animation-delay: -2.5s; }
    @keyframes floaty{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(20px, -10px) scale(1.05); }
    }

    .loader-card{
      position: relative;
      z-index: 1;
      width: min(420px, 92vw);
      padding: 22px;
      border-radius: 22px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      text-align: center;
      animation: pop 700ms cubic-bezier(.2,.9,.2,1) both;
    }
    @keyframes pop { from { transform: translateY(10px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    .loader-icon{
      width: 78px;
      height: 78px;
      border-radius: 18px;
      margin: 0 auto 14px;
      background: rgba(255,255,255,0.92);
      display: grid;
      place-items: center;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
    }
    .loader-icon::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: conic-gradient(from 180deg, rgba(79,70,229,0), rgba(79,70,229,.35), rgba(16,185,129,.35), rgba(245,158,11,.35), rgba(79,70,229,0));
      animation: spin 2.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-icon svg{
      width: 40px; height: 40px;
      fill: #4f46e5;
      position: relative;
      z-index: 1;
    }

    .loader-title{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .loader-sub{
      font-size: 13px;
      opacity: 0.85;
      margin-bottom: 14px;
    }
    .loader-progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.16);
    }
    .loader-progress > div{
      height: 100%;
      width: 35%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.85));
      animation: loadbar 1.3s ease-in-out infinite;
    }
    @keyframes loadbar{
      0%{ transform: translateX(-120%); }
      100%{ transform: translateX(320%); }
    }

    /* ---------- Overlays / Modals ---------- */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1001;
      display: none;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1002;
      display: none;
      width: min(360px, 92vw);
      padding: 22px;
      border-radius: 18px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 25px 70px rgba(0,0,0,0.45);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      text-align: center;
    }

    .modal h3{
      font-size: 18px;
      margin-bottom: 8px;
      color: #121424;
    }
    .modal p{
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .email-prompt input{
      padding: 12px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      width: 100%;
      outline: none;
    }
    .email-actions{
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .btn{
      border: none;
      cursor: pointer;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }
    .btn-primary{
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #fff;
    }
    .btn-ghost{
      background: rgba(17,24,39,0.08);
      color: #111827;
    }

    /* ---------- Notify + change email ---------- */
    .notify-btn {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: none;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.92);
      color: #3730a3;
      font-family: system-ui, sans-serif;
      font-size: 15px;
      font-weight: 800;
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
    }
    .notify-btn:hover{ filter: brightness(0.98); }

    .change-email-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: none;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(17,24,39,0.35);
      color: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0.85;
    }
    .change-email-btn:hover{ opacity: 1; }

    /* ---------- CTA Dock (Android + Thanks) ---------- */
    .cta-wrap{
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      pointer-events: none; /* –≤–∫–ª—é—á–∏–º —É –¥–µ—Ç–µ–π */
    }

    .cta-dock{
      pointer-events: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      border-radius: 18px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transform-origin: left bottom;
      transition: transform .22s ease, opacity .22s ease, filter .22s ease;
    }

    .cta-dock.is-hidden{
      opacity: 0;
      transform: translateY(14px) scale(0.96);
      pointer-events: none;
      filter: blur(2px);
    }

    .cta-btn{
      width: 240px;
      max-width: min(72vw, 260px);
      text-decoration: none;
      border: none;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: #fff;
      box-shadow: 0 10px 26px rgba(0,0,0,0.25);
      transition: transform .12s ease, filter .12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .cta-btn:active{ transform: scale(.985); }
    .cta-btn small{ opacity: .9; font-weight: 700; }
    .cta-android{
      background: linear-gradient(135deg, #10b981, #059669);
    }
    .cta-thanks{
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .cta-toggle{
      pointer-events: auto;
      border: none;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(17,24,39,0.45);
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity: 0.92;
      transition: opacity .2s ease, transform .12s ease;
    }
    .cta-toggle:active{ transform: scale(.98); }
    .cta-toggle .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.18);
    }

    /* ---------- Thanks modal extras ---------- */
    .thanks-timer{
      font-size: 30px;
      font-weight: 900;
      color: #d97706;
      margin: 10px 0 14px;
    }
    .thanks-links{
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .link-btn{
      border-radius: 12px;
      padding: 12px 14px;
      color: #fff;
      text-decoration: none;
      font-weight: 800;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .wa { background: #25d366; }
    .tg { background: #0088cc; }
  </style>
</head>

<body>
  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="loader-card">
      <div class="loader-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
        </svg>
      </div>
      <div class="loader-title">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫</div>
      <div class="loader-sub">–ü–æ–¥–Ω–∏–º–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å‚Ä¶ –µ—â—ë –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ ‚ú®</div>
      <div class="loader-progress" aria-hidden="true"><div></div></div>
    </div>
  </div>

  <!-- Overlays -->
  <div class="overlay" id="overlay" onclick="closeEmailPrompt()"></div>
  <div class="overlay" id="thanksOverlay" onclick="closeThanksModal()" style="display:none"></div>

  <!-- Email modal -->
  <div class="modal email-prompt" id="emailPrompt">
    <h3>üìß Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
    <p>–£–∫–∞–∂–∏ email –∏–∑ —Å–∏—Å—Ç–µ–º—ã ‚Äî –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å –ø—É—à–∏ —Ç—É–¥–∞, –∫—É–¥–∞ –Ω–∞–¥–æ.</p>
    <input type="email" id="promptEmail" placeholder="email@example.com" />
    <div class="email-actions">
      <button class="btn btn-primary" onclick="submitEmail()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚úÖ</button>
      <button class="btn btn-ghost" onclick="closeEmailPrompt()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- Thanks modal -->
  <div class="modal" id="thanksModal">
    <h3>‚òï –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h3>
    <p>–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã—Ä—É—á–∞–µ—Ç ‚Äî –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å ‚Äú—Å–ø–∞—Å–∏–±–æ‚Äù (–∏ —á—É—Ç—å-—á—É—Ç—å –∑–∞–º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∞ üòÑ).</p>
    <div class="thanks-timer" id="thanksTimer">10</div>
    <div class="thanks-links">
      <a class="link-btn wa" href="https://wa.me/79161244687?text=–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫! ‚òï" target="_blank" rel="noopener">üí¨ WhatsApp</a>
      <a class="link-btn tg" href="https://t.me/WeltkindVPN" target="_blank" rel="noopener">‚úàÔ∏è Telegram</a>
    </div>
    <div class="email-actions" style="margin-top:14px;">
      <button class="btn btn-ghost" onclick="closeThanksModal()">–ù–µ —Å–µ–π—á–∞—Å</button>
    </div>
  </div>

  <!-- Notify + change email -->
  <button class="notify-btn" id="notifyBtn" onclick="requestPermission()">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
  <button class="change-email-btn" id="changeEmailBtn" onclick="changeEmail()">‚úèÔ∏è Email</button>

  <!-- CTA Dock -->
  <div class="cta-wrap">
    <div class="cta-dock" id="ctaDock">
      <a class="cta-btn cta-android" href="https://github.com/Weltkind666/planzayavok-pwa/releases/download/Planner/default.apk" target="_blank" rel="noopener">
        <span>üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ Android<br><small>APK (–≤ –æ–¥–∏–Ω —Ç–∞–ø)</small></span>
        <span>‚Üí</span>
      </a>
      <button class="cta-btn cta-thanks" onclick="openThanksModal()">
        <span>‚òï –°–∫–∞–∑–∞—Ç—å ‚Äú—Å–ø–∞—Å–∏–±–æ‚Äù<br><small>–ø–∞—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</small></span>
        <span>‚Üí</span>
      </button>
    </div>

    <button class="cta-toggle" id="ctaToggle" onclick="toggleCtaDock()" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫">
      <span class="dot" aria-hidden="true"></span>
      <span id="ctaToggleText">–ü–æ–¥—Å–∫–∞–∑–∫–∏</span>
    </button>
  </div>

  <!-- App -->
  <iframe id="app" class="hidden"
          src="https://script.google.com/macros/s/AKfycbziJi6zBrH0meVhi27JPdFquQYGhjDK2iX0EIjKrRplhW8E9CQZAkA1ZQpdiNqVsGI1/exec"></iframe>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

  <script>
    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD2HkY76nLBhE7GuCwXi1j6qzKyYPSmypg",
      authDomain: "planzayavok.firebaseapp.com",
      projectId: "planzayavok",
      storageBucket: "planzayavok.firebasestorage.app",
      messagingSenderId: "655180080768",
      appId: "1:655180080768:web:449d8189bf747d34b46865"
    };
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // ---------- SW ----------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('SW registered'))
        .catch((e) => console.log('SW error', e));
    }

    // ---------- DOM ----------
    const iframe = document.getElementById('app');
    const loader = document.getElementById('loader');
    const notifyBtn = document.getElementById('notifyBtn');
    const emailPrompt = document.getElementById('emailPrompt');
    const overlay = document.getElementById('overlay');
    const changeEmailBtn = document.getElementById('changeEmailBtn');

    const thanksModal = document.getElementById('thanksModal');
    const thanksOverlay = document.getElementById('thanksOverlay');
    const thanksTimer = document.getElementById('thanksTimer');

    const ctaDock = document.getElementById('ctaDock');
    const ctaToggleText = document.getElementById('ctaToggleText');

    let timerInterval = null;
    let ctaAutoHideTimer = null;

    // ---------- App load ----------
    iframe.onload = function () {
      setTimeout(function () {
        loader.classList.add('hidden');
        iframe.classList.remove('hidden');
        checkNotificationPermission();
        initCtaDock();
      }, 450);
    };

    // ---------- CTA Dock logic ----------
    function setCtaDockHidden(hidden) {
      if (hidden) {
        ctaDock.classList.add('is-hidden');
        localStorage.setItem('ctaDockState', 'hidden');
        ctaToggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
      } else {
        ctaDock.classList.remove('is-hidden');
        localStorage.setItem('ctaDockState', 'shown');
        ctaToggleText.textContent = '–°–∫—Ä—ã—Ç—å';
      }
    }

    function toggleCtaDock() {
      const isHidden = ctaDock.classList.contains('is-hidden');
      setCtaDockHidden(!isHidden);

      // –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî —Ç–æ–∂–µ –∞–≤—Ç–æ-–ø—Ä—è—á–µ–º —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
      if (!isHidden) scheduleCtaAutoHide(6000);
    }

    function scheduleCtaAutoHide(ms) {
      if (ctaAutoHideTimer) clearTimeout(ctaAutoHideTimer);
      ctaAutoHideTimer = setTimeout(() => setCtaDockHidden(true), ms);
    }

    function initCtaDock() {
      // –ï—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –ø—Ä—è—Ç–∞–ª ‚Äî –±–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–≤ –ª–∏—Ü–æ"
      const saved = localStorage.getItem('ctaDockState'); // 'shown' | 'hidden' | null
      if (saved === 'hidden') {
        setCtaDockHidden(true);
      } else {
        // –ü–æ–∫–∞–∑–∞—Ç—å 1 —Ä–∞–∑ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ—Ç–æ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–ø—Ä—è—Ç–∞—Ç—å
        setCtaDockHidden(false);
        scheduleCtaAutoHide(5500);
      }

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞–ø–Ω—É–ª –ø–æ —ç–∫—Ä–∞–Ω—É ‚Äî –º–æ–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å —Å–∫—Ä—ã—Ç–∏–µ,
      // —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ç–æ—Ä—á–∞–ª–∏.
      document.addEventListener('pointerdown', (e) => {
        // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –µ—Å–ª–∏ —Ç—ã–∫ –ø–æ —Å–∞–º–∏–º CTA/–º–æ–¥–∞–ª–∫–∞–º
        const inCta = e.target.closest('.cta-wrap');
        const inModal = e.target.closest('.modal');
        if (inCta || inModal) return;
        scheduleCtaAutoHide(1200);
      }, { passive: true });
    }

    // ---------- Thanks modal ----------
    function openThanksModal() {
      // –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ç–∞–∫–∂–µ –ø—Ä—è—á–µ—Ç –¥–æ–∫ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª)
      setCtaDockHidden(true);

      thanksModal.style.display = 'block';
      thanksOverlay.style.display = 'block';

      let seconds = 10;
      thanksTimer.textContent = seconds;

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(function () {
        seconds--;
        thanksTimer.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          closeThanksModal();
          // –º—è–≥–∫–æ: –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º WA. –ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ ‚Äî —É–¥–∞–ª–∏ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É.
          window.open('https://wa.me/79161244687?text=–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞—è–≤–æ–∫! ‚òï', '_blank', 'noopener');
        }
      }, 1000);
    }

    function closeThanksModal() {
      thanksModal.style.display = 'none';
      thanksOverlay.style.display = 'none';
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // ---------- Email modal ----------
    function closeEmailPrompt() {
      emailPrompt.style.display = 'none';
      overlay.style.display = 'none';
    }

    function changeEmail() {
      var currentEmail = localStorage.getItem('pushEmail') || '';
      document.getElementById('promptEmail').value = currentEmail;
      emailPrompt.style.display = 'block';
      overlay.style.display = 'block';
      document.getElementById('promptEmail').focus();
    }

    function submitEmail() {
      const email = document.getElementById('promptEmail').value.trim();
      if (email) {
        localStorage.setItem('pushEmail', email);
        closeEmailPrompt();
        checkNotificationPermission();
      }
    }

    // ---------- Notifications ----------
    function checkNotificationPermission() {
      if (!('Notification' in window)) return;

      var savedEmail = localStorage.getItem('pushEmail') || '';

      if (Notification.permission === 'default') {
        notifyBtn.style.display = 'block';
        notifyBtn.textContent = 'üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
        notifyBtn.style.background = 'rgba(255,255,255,0.92)';
        notifyBtn.style.color = '#3730a3';
        changeEmailBtn.style.display = 'none';
      } else if (Notification.permission === 'denied') {
        notifyBtn.style.display = 'none';
        changeEmailBtn.style.display = 'none';
      } else {
        notifyBtn.style.display = 'none';
        if (savedEmail) {
          changeEmailBtn.style.display = 'block';
        } else {
          notifyBtn.style.display = 'block';
          notifyBtn.textContent = 'üîî –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
          notifyBtn.style.background = 'rgba(255,255,255,0.92)';
          notifyBtn.style.color = '#3730a3';
          changeEmailBtn.style.display = 'none';
        }
      }
    }

    async function requestPermission() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          notifyBtn.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω‚Ä¶';
          notifyBtn.style.background = '#10b981';
          notifyBtn.style.color = '#fff';
          await getTokenAndSave();
          setTimeout(() => notifyBtn.style.display = 'none', 1200);
        } else {
          notifyBtn.textContent = 'üîï –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
          notifyBtn.style.background = '#ef4444';
          notifyBtn.style.color = '#fff';
          setTimeout(() => notifyBtn.style.display = 'none', 2500);
        }
      } catch (err) {
        console.error('Permission error:', err);
        notifyBtn.textContent = '‚ùå –û—à–∏–±–∫–∞';
        notifyBtn.style.background = '#ef4444';
        notifyBtn.style.color = '#fff';
      }
    }

    async function getTokenAndSave() {
      try {
        const swReg = await navigator.serviceWorker.register('firebase-messaging-sw.js');

        // –í–ê–ñ–ù–û: —Å—é–¥–∞ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π VAPID –∫–ª—é—á
        const token = await messaging.getToken({
          vapidKey: 'YOUR_VAPID_KEY_HERE',
          serviceWorkerRegistration: swReg
        });

        console.log('Token:', token);
        // –ó–¥–µ—Å—å –¥–æ–±–∞–≤—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞/email –∫—É–¥–∞ –Ω—É–∂–Ω–æ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
      } catch (err) {
        console.error('Token error:', err);
        notifyBtn.textContent = '‚ùå –¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω';
        notifyBtn.style.background = '#ef4444';
        notifyBtn.style.color = '#fff';
      }
    }
  </script>
</body>
</html>
